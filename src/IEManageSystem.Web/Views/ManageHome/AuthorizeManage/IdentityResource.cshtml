<style type="text/css">
  .resource{
    margin-bottom: auto;
  }

  .error{
    padding-bottom: 10px;
  }
</style>
<div class="d-flex flex-column h-100">
  <table class="table table-hover resource">
      <thead class="thead-dark">
        <tr>
          <th>资源名</th>
          <th>资源描述</th>
          <th>资源Claim</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="datadiv" data-element="dataElement" data-iP="true" data-iL="true">
        <tr data-element="dataElement" data-n="id" data-resourceId="{{Value}}">
          <td data-element="dataElement" data-n="displayName">{{Value}}</td>
          <td data-element="dataElement" data-n="description">{{Value}}</td>
          <td data-element="dataElement" data-n="userClaimsString">{{Value}}</td>
          <td>
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#resourceData">修改</button>
            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deleteData" onclick="deleteConfirm(this)">删除</button>
          </td>
        </tr>
      </tbody>
  </table>
  <div class="w-100 d-flex justify-content-between">
    <div>
      <ul class="pagination">
        <li id="resourcePre" class="page-item"><a class="page-link" href="#" onclick="preClick()">上一页</a></li>
        <li id="resourceNext" class="page-item"><a class="page-link" href="#" onclick="nextClick()">下一页</a></li>
      </ul>
    </div>
    <div class="">
      <button type="button" class="btn btn-success" data-toggle="modal" data-target="#resourceData">+添加数据</button>
    </div>
  </div>
</div>

<!-- 数据 -->
<div class="modal fade" id="resourceData">
  <div class="modal-dialog">
    <div class="modal-content">
 
      <!-- 模态框头部 -->
      <div class="modal-header">
        <h4 class="modal-title">模态框头部</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
 
      <!-- 模态框主体 -->
      <div class="modal-body">
        <form>
          <div id="resourceDataError" class="text-danger error"></div>
          <div class="form-group">
            <label for="text">资源标识名</label>
            <input id="resourceName" type="text" class="form-control">
          </div>
          <div class="form-group">
            <label for="text">资源名</label>
            <input id="resourceDisplayName" type="text" class="form-control">
          </div>
          <div class="form-group">
            <label for="text">资源描述</label>
            <input id="resourceDescription" type="text" class="form-control">
          </div>
          <div class="form-group">
            <label for="text">资源Claim</label>
          </div>
          <div id="claimTypes" class="form-check">
          </div>
        </form>
      </div>
 
      <!-- 模态框底部 -->
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="addResourceData()">提交</button>
        <button id="resourceDataClose" type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
      </div>
 
    </div>
  </div>
</div>

<!-- 删除确认框 -->
<div class="modal fade" id="deleteData">
  <div class="modal-dialog">
    <div class="modal-content">
 
      <!-- 模态框头部 -->
      <div class="modal-header">
        <h4 class="modal-title">确认删除？</h4>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
 
      <!-- 模态框主体 -->
      <div class="modal-body">
        <div id="deleteDataError" class="text-danger error"></div>
        你正在删除xxxx
      </div>
 
      <!-- 模态框底部 -->
      <div class="modal-footer">
        <button id="deleteDataDelete" data-resourceId="" type="button" class="btn btn-danger" onclick="deleteResourceData()">删除</button>
        <button id="deleteDataClose" type="button" class="btn btn-secondary" data-dismiss="modal">关闭</button>
      </div>
 
    </div>
  </div>
</div>

<script src="~/js/Other/selectSingleData.js"></script>
<script>
  var curPageIndex = 1;
  var pageSize = 10;
  var factoryId = null;

  // 获取资源回调
  function GetResourceCall(data){
    if(data.isSuccess == true){
      let identityResources = data.value.identityResources;

      for(let item in identityResources){
        let userClaimsString = "";

        for(let childItem in identityResources[item].userClaims){
          userClaimsString = userClaimsString + "[" + identityResources[item].userClaims[childItem].type + "]" + " ";
        }

        identityResources[item].userClaimsString = userClaimsString;
      }

      ReloadData(identityResources, null, factoryId);

      if(identityResources.length < pageSize){
        notNextHandle();
      }
      else{
        haveNextHandle();
      }

      if(curPageIndex > 1){
        havePreHandle();
      }
      else{
        notNPreHandle();
      }
    }
  }

  // 获取资源
  function GetResource()
  {
    var postdata = {
      pageIndex: curPageIndex,
      pageSize: pageSize,
    };
    $.ajax({
      url:"/api/IdentityResourceManage/GetIdentityResource",
      type:"post",
      contentType: "application/json",
      data: JSON.stringify(postdata),
      dataType: 'json',
      success: GetResourceCall,
    });
  }

  // 没有下一页处理
  function notNextHandle(){
    $("#resourceNext").addClass("disabled");
  }

  // 有下一页处理
  function haveNextHandle(){
    $("#resourceNext").removeClass("disabled");
  }

  // 没有上一页处理
  function notNPreHandle()
  {
    $("#resourcePre").addClass("disabled");
  }

  // 有上一页处理
  function havePreHandle(){
    $("#resourcePre").removeClass("disabled");
  }

  // 上一页
  function preClick(){
    curPageIndex = curPageIndex - 1;
    GetResource();
  }

  // 下一页
  function nextClick(){
    curPageIndex = curPageIndex + 1;
    GetResource();
  }

  // 生成资源数据
  function createResourceData()
  {
    var claims = new Array();
    var claimHtmls = $("#claimTypes").find("input");
    for(var n = 0; n < claimHtmls.length; n++){
      var claimHtml = claimHtmls.eq(n);
      if(claimHtml.is(':checked'))
      {
        claims.push(claimHtml.val());
      }
    }

    var data = {
      Name: $("#resourceName").val(),
      DisplayName: $("#resourceDisplayName").val(),
      Description: $("#resourceDescription").val(),
      Claims: claims,
    }

    return data;
  }

  // 添加资源数据回调
  function addResourceDataCall(data){
    if(data.isSuccess == true){
      $("#resourceDataClose").click();
      GetResource();
    }
    else{
      $("#resourceDataError").text(data.message);
      setTimeout('$("#resourceDataError").html("")',3000);
    }
  }

  // 添加资源数据
  function addResourceData(){
    var postdata = createResourceData();

    $.ajax({
      url:"/api/IdentityResourceManage/AddIdentityResource",
      type:"post",
      contentType: "application/json",
      data: JSON.stringify(postdata),
      dataType: 'json',
      success: addResourceDataCall,
    });
  }

  // 删除身份资源回调
  function deleteResourceDataCall(data){
    if(data.isSuccess == true){
      $("#deleteDataClose").click();
      GetResource();
    }
    else{
      $("#deleteDataError").text(data.message);
      setTimeout('$("#deleteDataError").html("")',3000);
    }
  }

  // 删除数据资源
  function deleteResourceData()
  {
    var id = $("#deleteDataDelete").attr("data-resourceId");

    var postdata = {
      IdentityResourceId: id,
    }

    $.ajax({
      url:"/api/IdentityResourceManage/DeleteIdentityResource",
      type:"post",
      contentType: "application/json",
      data: JSON.stringify(postdata),
      dataType: 'json',
      success: deleteResourceDataCall,
    });
  }

  function deleteConfirm(curele){
    var id = $(curele).parents("tr").attr("data-resourceId");
    $("#deleteDataDelete").attr("data-resourceId", id);
  }

  // 初始化
  function init()
  {
    $.get("/api/ClaimManage/GetWebClaimTypes", function(data){
      if(data.isSuccess == true){
        for(var item in data.value){
          var claimhtml = 
            '<label class="form-check-label col-md-4 float-left">'+
              '<input class="form-check-input" type="checkbox" value="'+data.value[item]+'">'+
              data.value[item] +
            '</label>';

          $("#claimTypes").append(claimhtml);
        }
      }
    });

    GetResource();
    factoryId = BuildData(null, $("#datadiv"));
  }

  $(function(){
    console.log(1);

    init();
  });
</script>